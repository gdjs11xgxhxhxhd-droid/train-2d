<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Симулятор Электрички PRO — Максимальный Реализм</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #020617;
            font-family: 'Segoe UI', system-ui, sans-serif;
            color: white;
            user-select: none;
        }
        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        canvas {
            display: block;
            background: #000;
            width: 100%;
            height: 70%;
        }
        #ui-panel {
            height: 30%;
            background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 20px;
            border-top: 4px solid #334155;
            box-shadow: 0 -20px 40px rgba(0,0,0,0.6);
            z-index: 10;
        }
        .gauge-label { font-size: 11px; color: #64748b; text-transform: uppercase; letter-spacing: 2px; font-weight: 700; }
        .gauge-value { font-size: 32px; font-weight: 900; color: #fbbf24; font-variant-numeric: tabular-nums; text-shadow: 0 0 10px rgba(251, 191, 36, 0.3); }
        .btn {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 16px;
            font-weight: 800;
            box-shadow: 0 6px 0 rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .btn:active { transform: translateY(4px); box-shadow: 0 2px 0 rgba(0,0,0,0.3); }
        .btn-green { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
        .btn-red { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; }
        .btn-blue { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; }
        .btn-open { background: linear-gradient(135deg, #fbbf24 0%, #d97706 100%); color: #451a03; }
        
        #message-box {
            position: absolute;
            top: 40px;
            left: 50%;
            transform: translateX(-50%);
            padding: 16px 32px;
            background: rgba(15, 23, 42, 0.9);
            color: #fbbf24;
            border: 1px solid #334155;
            border-radius: 20px;
            pointer-events: none;
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            font-weight: 700;
            backdrop-filter: blur(12px);
            z-index: 100;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
        }
    </style>
</head>
<body>

<div id="game-container">
    <div id="message-box">Система готова. Приятной поездки!</div>
    <canvas id="gameCanvas"></canvas>
    
    <div id="ui-panel">
        <div class="flex flex-col justify-around bg-slate-900/60 p-5 rounded-2xl border border-slate-700/50">
            <div>
                <div class="gauge-label">Спидометр</div>
                <div id="speed-val" class="gauge-value">0 <span class="text-sm font-medium text-slate-500">км/ч</span></div>
            </div>
            <div>
                <div class="gauge-label">Заполнение</div>
                <div id="pass-val" class="gauge-value">0 <span class="text-sm font-medium text-slate-500">/ 300</span></div>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-6">
            <div id="btn-brake" class="btn btn-red text-2xl h-full uppercase tracking-tighter">Торможение<span class="text-xs font-medium opacity-80 mt-1">(Клавиша S)</span></div>
            <div id="btn-accel" class="btn btn-green text-2xl h-full uppercase tracking-tighter">Тяга<span class="text-xs font-medium opacity-80 mt-1">(Клавиша W)</span></div>
        </div>

        <div class="flex flex-col gap-3">
            <div id="btn-doors" class="btn btn-blue h-2/3 text-lg uppercase tracking-tight">Управление дверями (Space)</div>
            <div class="text-center bg-slate-950/80 rounded-xl py-2 border border-slate-800">
                <div id="next-stop" class="font-bold text-amber-500 text-[11px] truncate uppercase tracking-[0.2em]">След: СТАНЦИЯ ЛЕСНАЯ</div>
            </div>
        </div>
    </div>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const speedDisplay = document.getElementById('speed-val');
    const passDisplay = document.getElementById('pass-val');
    const nextStopDisplay = document.getElementById('next-stop');
    const msgBox = document.getElementById('message-box');

    let width, height;
    const WIRE_Y_OFFSET = 240; 

    function resize() {
        width = canvas.width = window.innerWidth;
        height = canvas.height = window.innerHeight * 0.7;
    }
    window.addEventListener('resize', resize);
    resize();

    const train = {
        carWidth: 620,
        height: 105,
        speed: 0,
        accel: 0,
        maxSpeed: 140,
        doorState: 0,
        isDoorsOpen: false,
        passengers: 0,
        maxPassengers: 300,
        distance: 0,
        y: 0,
        wheelRotation: 0,
        gap: 20,
        vibration: 0
    };

    const STATIONS = [
        { name: "Центральный Вокзал", pos: 100 },
        { name: "Платформа Заречье", pos: 8000 },
        { name: "Лесной Массив", pos: 18000 },
        { name: "Озерный Край", pos: 28000 },
        { name: "Конечная Станция", pos: 40000 }
    ];

    let currentStationIdx = 0;
    let keys = {};
    let sparks = [];

    window.addEventListener('keydown', e => {
        keys[e.code] = true;
        if (e.code === 'Space') toggleDoors();
    });
    window.addEventListener('keyup', e => keys[e.code] = false);

    function showMessage(text) {
        msgBox.innerText = text;
        msgBox.style.opacity = 1;
        msgBox.style.top = '60px';
        setTimeout(() => {
            msgBox.style.opacity = 0;
            msgBox.style.top = '40px';
        }, 3500);
    }

    function toggleDoors() {
        if (train.speed > 3) {
            showMessage("СИСТЕМА: Блокировка! Двери нельзя открыть в движении.");
            return;
        }
        train.isDoorsOpen = !train.isDoorsOpen;
        const btn = document.getElementById('btn-doors');
        btn.className = `btn ${train.isDoorsOpen ? 'btn-open' : 'btn-blue'} h-2/3 text-lg uppercase`;
        btn.innerText = train.isDoorsOpen ? 'ЗАКРЫТЬ ДВЕРИ (Space)' : 'ОТКРЫТЬ ДВЕРИ (Space)';
    }

    function handleStation() {
        const nextSt = STATIONS[currentStationIdx + 1];
        if (!nextSt) return;

        const distToStation = Math.abs(train.distance - nextSt.pos);
        
        if (distToStation < 300 && train.doorState > 0.9) {
            const off = Math.floor(Math.random() * (train.passengers * 0.4));
            const on = Math.floor(Math.random() * (train.maxPassengers - (train.passengers - off)));
            
            train.passengers = Math.min(train.maxPassengers, train.passengers - off + on);
            currentStationIdx++;
            nextStopDisplay.innerText = STATIONS[currentStationIdx + 1] ? "След: " + STATIONS[currentStationIdx + 1].name : "КОНЕЧНАЯ";
            showMessage(`Прибыли: ${nextSt.name}. Вышло: ${off}, Зашло: ${on}`);
        }
    }

    function drawScenery() {
        const groundY = height * 0.85;
        train.y = groundY - 130;

        // Небо с градиентом
        const skyGrad = ctx.createLinearGradient(0, 0, 0, height);
        skyGrad.addColorStop(0, "#0c4a6e");
        skyGrad.addColorStop(1, "#38bdf8");
        ctx.fillStyle = skyGrad;
        ctx.fillRect(0, 0, width, height);

        // Солнце
        ctx.shadowBlur = 40;
        ctx.shadowColor = "white";
        ctx.fillStyle = "#fff7ed";
        ctx.beginPath(); ctx.arc(width * 0.15, 80, 40, 0, Math.PI * 2); ctx.fill();
        ctx.shadowBlur = 0;

        // Облака
        ctx.fillStyle = "rgba(255, 255, 255, 0.4)";
        for(let i=0; i<4; i++) {
            const cx = ((i*900) - train.distance * 0.05) % (width + 400);
            ctx.beginPath(); ctx.arc(cx, 100, 30, 0, Math.PI*2); ctx.arc(cx+40, 90, 45, 0, Math.PI*2); ctx.arc(cx+90, 100, 35, 0, Math.PI*2); ctx.fill();
        }

        // Дальние горы (параллакс)
        ctx.fillStyle = "#0369a1";
        for (let i = 0; i < 6; i++) {
            const hX = (i * 800) - (train.distance * 0.1) % 800;
            ctx.beginPath();
            ctx.moveTo(hX - 300, groundY);
            ctx.quadraticCurveTo(hX + 100, groundY - 180, hX + 500, groundY);
            ctx.fill();
        }

        // Деревья у путей
        for (let i = -5; i < 30; i++) {
            const objX = (i * 400) - (train.distance * 1.0) % 400;
            
            // Деревья
            ctx.fillStyle = "#14532d";
            ctx.beginPath();
            ctx.moveTo(objX + 50, groundY);
            ctx.lineTo(objX + 85, groundY - 120);
            ctx.lineTo(objX + 120, groundY);
            ctx.fill();

            // Опоры КС
            ctx.strokeStyle = "#334155";
            ctx.lineWidth = 10;
            ctx.beginPath();
            ctx.moveTo(objX + 300, groundY);
            ctx.lineTo(objX + 300, groundY - 260);
            ctx.stroke();
            ctx.lineWidth = 5;
            ctx.beginPath();
            ctx.moveTo(objX + 300, groundY - 260);
            ctx.lineTo(objX + 480, groundY - 245);
            ctx.stroke();
            
            // Провода
            ctx.strokeStyle = "#1e293b";
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(0, groundY - WIRE_Y_OFFSET);
            ctx.lineTo(width, groundY - WIRE_Y_OFFSET);
            ctx.stroke();
        }

        // Земля/насыпь
        ctx.fillStyle = "#334155";
        ctx.fillRect(0, groundY, width, height - groundY);
        
        // Шпалы
        ctx.strokeStyle = "#0f172a";
        ctx.lineWidth = 14;
        for (let i = -10; i < 60; i++) {
            const sX = (i * 70) - (train.distance * 1.0) % 70;
            ctx.beginPath(); ctx.moveTo(sX, groundY + 18); ctx.lineTo(sX + 40, groundY + 18); ctx.stroke();
        }

        // Рельсы
        ctx.strokeStyle = "#94a3b8";
        ctx.lineWidth = 6;
        ctx.beginPath();
        ctx.moveTo(0, groundY + 8); ctx.lineTo(width, groundY + 8);
        ctx.moveTo(0, groundY + 28); ctx.lineTo(width, groundY + 28);
        ctx.stroke();
    }

    function drawWheel(x, y, rotation) {
        ctx.save();
        ctx.translate(x, y);
        ctx.rotate(rotation);
        ctx.fillStyle = "#1e293b";
        ctx.beginPath(); ctx.arc(0, 0, 18, 0, Math.PI * 2); ctx.fill();
        ctx.strokeStyle = "#475569";
        ctx.lineWidth = 4;
        ctx.beginPath(); ctx.arc(0, 0, 14, 0, Math.PI * 2); ctx.stroke();
        ctx.lineWidth = 2;
        for(let i=0; i<4; i++) {
            ctx.rotate(Math.PI/2);
            ctx.beginPath(); ctx.moveTo(0, -14); ctx.lineTo(0, 14); ctx.stroke();
        }
        ctx.restore();
    }

    function drawDoors(x, y, openState) {
        const doorW = 55;
        const doorH = 92;
        ctx.fillStyle = "#020617";
        ctx.fillRect(x, y, doorW, doorH);
        
        const leafW = doorW / 2;
        const slide = leafW * 0.9 * openState;
        
        ctx.fillStyle = "#166534";
        ctx.strokeStyle = "#4ade80";
        ctx.lineWidth = 1.5;
        
        // Левая створка
        ctx.fillRect(x - slide, y, leafW, doorH);
        ctx.strokeRect(x - slide, y, leafW, doorH);
        
        // Правая створка
        ctx.fillRect(x + leafW + slide, y, leafW, doorH);
        ctx.strokeRect(x + leafW + slide, y, leafW, doorH);
        
        // Стекла в дверях
        ctx.fillStyle = "rgba(186, 230, 253, 0.6)";
        ctx.fillRect(x + 5 - slide, y + 10, leafW - 10, 35);
        ctx.fillRect(x + leafW + 5 + slide, y + 10, leafW - 10, 35);
    }

    function drawVagon(x, y, isHead = false) {
        const w = train.carWidth;
        const h = train.height;
        
        // Тень поезда
        ctx.fillStyle = "rgba(0,0,0,0.35)";
        ctx.fillRect(x + 20, y + h + 15, w - 40, 12);

        // Колеса
        drawWheel(x + 75, y + h + 12, train.wheelRotation);
        drawWheel(x + 135, y + h + 12, train.wheelRotation);
        drawWheel(x + w - 135, y + h + 12, train.wheelRotation);
        drawWheel(x + w - 75, y + h + 12, train.wheelRotation);

        // Кузов
        const bodyGrad = ctx.createLinearGradient(x, y, x, y + h);
        bodyGrad.addColorStop(0, "#15803d");
        bodyGrad.addColorStop(0.5, "#166534");
        bodyGrad.addColorStop(1, "#064e3b");
        ctx.fillStyle = bodyGrad;
        ctx.beginPath();
        ctx.roundRect(x, y, w, h, isHead ? [10, 45, 10, 10] : 10);
        ctx.fill();
        ctx.strokeStyle = "rgba(255,255,255,0.15)";
        ctx.lineWidth = 2;
        ctx.stroke();

        // Полоса
        ctx.fillStyle = "#fbbf24";
        ctx.fillRect(x, y + 68, w, 8);

        // Окна
        const winY = y + 15;
        const winW = 68;
        const winH = 45;
        const winStartX = x + 120;
        for(let i = 0; i < 4; i++) {
            const wx = winStartX + i * 85;
            ctx.fillStyle = "#0c4a6e";
            ctx.fillRect(wx, winY, winW, winH);
            const winGrad = ctx.createLinearGradient(wx, winY, wx, winY + winH);
            winGrad.addColorStop(0, "#bae6fd");
            winGrad.addColorStop(1, "#38bdf8");
            ctx.fillStyle = winGrad;
            ctx.globalAlpha = 0.85;
            ctx.fillRect(wx + 3, winY + 3, winW - 6, winH - 6);
            ctx.globalAlpha = 1.0;
        }

        // Двери
        drawDoors(x + 35, y + 5, train.doorState);
        drawDoors(x + 470, y + 5, train.doorState);

        if (isHead) {
            // Кабина машиниста
            const cabX = x + 555;
            ctx.fillStyle = "#0c4a6e";
            ctx.beginPath(); ctx.roundRect(cabX, winY, 55, 52, [5, 15, 5, 5]); ctx.fill();
            const cabGrad = ctx.createLinearGradient(cabX, winY, cabX, winY+52);
            cabGrad.addColorStop(0, "#bae6fd");
            cabGrad.addColorStop(1, "#0ea5e9");
            ctx.fillStyle = cabGrad;
            ctx.beginPath(); ctx.roundRect(cabX+3, winY+3, 49, 46, [3, 12, 3, 3]); ctx.fill();

            // Прожектор
            ctx.shadowBlur = 30;
            ctx.shadowColor = "#fef9c3";
            ctx.fillStyle = "#fff";
            ctx.beginPath(); ctx.arc(x + w - 12, y + 72, 8, 0, Math.PI*2); ctx.fill();
            ctx.shadowBlur = 0;

            // Пантограф
            const pX = x + 160;
            ctx.strokeStyle = "#475569";
            ctx.lineWidth = 6;
            ctx.beginPath();
            ctx.moveTo(pX, y);
            ctx.lineTo(pX + 40, y - 65);
            ctx.lineTo(pX + 10, y - 110);
            ctx.stroke();

            // Искры при движении
            if (train.speed > 40 && Math.random() > 0.85) {
                createSparks(pX + 10, y - 110);
            }
        }
    }

    function createSparks(x, y) {
        for(let i=0; i<3; i++) {
            sparks.push({
                x, y, 
                vx: (Math.random() - 0.5) * 8, 
                vy: (Math.random() - 0.5) * 8, 
                life: 1.0
            });
        }
    }

    function drawTrain() {
        // ФИКСИРОВАННАЯ ПОЗИЦИЯ: Голова всегда справа
        const headX = width - train.carWidth - 100; 
        const backX = headX - train.carWidth - train.gap;
        
        // Небольшая вибрация на скорости
        const shake = (train.speed / 140) * (Math.random() - 0.5) * 2.5;
        const y = train.y + shake;

        // Соединение (гармошка)
        ctx.fillStyle = "#1e293b";
        ctx.fillRect(backX + train.carWidth, y + 10, train.gap, train.height - 15);

        drawVagon(backX, y, false);
        drawVagon(headX, y, true);
    }

    function drawStations() {
        const groundY = height * 0.85;
        const trainScreenX = width - 100; 
        
        STATIONS.forEach(st => {
            const stX = (st.pos - train.distance) + trainScreenX;
            if (stX > -2200 && stX < width + 1000) {
                // Платформа
                const pGrad = ctx.createLinearGradient(stX, groundY, stX, groundY + 40);
                pGrad.addColorStop(0, "#94a3b8");
                pGrad.addColorStop(1, "#475569");
                ctx.fillStyle = pGrad;
                ctx.fillRect(stX, groundY - 14, 2000, 28);
                
                // Название
                ctx.fillStyle = "#f8fafc";
                ctx.roundRect(stX + 800, groundY - 210, 260, 75, 12);
                ctx.fill();
                ctx.strokeStyle = "#1e293b";
                ctx.lineWidth = 4;
                ctx.stroke();
                
                ctx.fillStyle = "#1e293b";
                ctx.font = "bold 20px 'Segoe UI'";
                ctx.textAlign = "center";
                ctx.fillText(st.name, stX + 930, groundY - 165);
                
                // Полоса безопасности
                ctx.fillStyle = "#fbbf24";
                ctx.fillRect(stX, groundY - 5, 2000, 4);
            }
        });
        ctx.textAlign = "left";
    }

    function update() {
        // Плавность дверей
        const doorSpeed = 0.04;
        if (train.isDoorsOpen) train.doorState = Math.min(1, train.doorState + doorSpeed);
        else train.doorState = Math.max(0, train.doorState - doorSpeed);

        // Управление
        if (keys['KeyW']) {
            if (train.doorState > 0.05) {
                showMessage("БЛОКИРОВКА: Тяга невозможна при открытых дверях!");
                train.accel = 0;
            } else {
                train.accel = 0.12;
            }
        } else if (keys['KeyS']) {
            train.accel = -0.25;
        } else {
            train.accel = -0.04; // Инерция
        }

        train.speed += train.accel;
        if (train.speed < 0) train.speed = 0;
        if (train.speed > train.maxSpeed) train.speed = train.maxSpeed;

        train.wheelRotation += (train.speed * 0.035);
        train.distance += train.speed * 0.55;

        if (train.speed === 0) handleStation();

        // Искры
        sparks.forEach(s => {
            s.x += s.vx;
            s.y += s.vy;
            s.life -= 0.02;
        });
        sparks = sparks.filter(s => s.life > 0);

        // Обновление UI
        speedDisplay.innerHTML = `${Math.floor(train.speed)} <span class="text-sm font-medium text-slate-500">км/ч</span>`;
        passDisplay.innerHTML = `${train.passengers} <span class="text-sm font-medium text-slate-500">/ 300</span>`;
    }

    function render() {
        ctx.clearRect(0, 0, width, height);
        drawScenery();
        drawStations();
        drawTrain();
        
        // Отрисовка искр
        sparks.forEach(s => {
            ctx.fillStyle = `rgba(254, 240, 138, ${s.life})`;
            ctx.beginPath(); ctx.arc(s.x, s.y, 2, 0, Math.PI*2); ctx.fill();
        });

        update();
        requestAnimationFrame(render);
    }

    document.getElementById('btn-accel').onmousedown = () => keys['KeyW'] = true;
    document.getElementById('btn-accel').onmouseup = () => keys['KeyW'] = false;
    document.getElementById('btn-brake').onmousedown = () => keys['KeyS'] = true;
    document.getElementById('btn-brake').onmouseup = () => keys['KeyS'] = false;
    document.getElementById('btn-doors').onclick = () => toggleDoors();

    window.onload = render;
</script>
</body>
</html>
